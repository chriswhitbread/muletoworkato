<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UST | Example Assessment - MuleSoft to Workato</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Mermaid for Diagrams -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        :root {
            /* UST Branding Colors */
            --ust-orange: #D6001C; 
            --ust-black: #000000;
            --ust-grey: #666666;
            --ust-light-grey: #f2f2f2;
            
            --bg: #f4f7fa;
            --card: #ffffff;
            --text: #333;
            --border: #e0e6ed;
            --success: #137333;
            --danger: #c5221f;
            --warning: #b06000;
            --ai-blue: #4285f4;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 380px;
            background: white;
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0,0,0,0.05);
            z-index: 10;
        }

        .logo {
            font-size: 1.4rem;
            font-weight: 800;
            color: var(--ust-black);
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 10px;
            letter-spacing: -0.5px;
            border-bottom: 2px solid var(--ust-orange);
            padding-bottom: 15px;
        }

        .logo span { 
            color: var(--ust-orange);
        }

        textarea {
            width: 100%;
            height: 120px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 6px;
            padding: 10px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.75rem;
            resize: vertical;
        }

        label {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--ust-grey);
            margin-bottom: 5px;
            display: block;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        button.primary-btn {
            background: var(--ust-black);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.2s;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        button.primary-btn:hover { background: var(--ust-orange); transform: translateY(-1px); }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
        }

        .stat-card {
            background: var(--card);
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid var(--ust-orange);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .stat-value { font-size: 1.8rem; font-weight: 700; color: var(--ust-black); }
        .stat-label { color: #777; font-size: 0.8rem; margin-top: 5px; text-transform: uppercase; }
        
        .effort-breakdown {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .effort-pill {
            background: #f4f7fa;
            padding: 5px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            color: #555;
            flex: 1;
            text-align: center;
        }
        .effort-pill strong { display: block; color: var(--ust-black); font-size: 0.9rem; }

        /* Detailed Analysis Section */
        .analysis-section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            border: 1px solid var(--border);
            min-height: 200px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 15px;
        }
        
        .section-header h2 { color: var(--ust-black); margin: 0; font-size: 1.8rem; }
        .section-header h3 { color: var(--ust-black); margin: 0; font-size: 1.5rem; }


        .flow-card {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 15px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03);
        }

        .flow-header {
            padding: 15px;
            background: #fcfcfc;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .flow-body {
            padding: 15px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .mapping-step {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.9rem;
            padding: 5px;
            border-radius: 4px;
        }
        .mapping-step:hover { background: #f9f9f9; }

        .icon { margin-right: 8px; width: 20px; text-align: center; }

        /* Badges */
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; }
        .badge-s { background: #e6f4ea; color: var(--success); }
        .badge-m { background: #fef7e0; color: var(--warning); }
        .badge-l { background: #fce8e6; color: var(--danger); }
        
        .pii-badge { 
            background: #fce8e6; color: var(--danger); border: 1px solid #fad2cf; 
            padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; margin-left: 8px;
        }

        /* Strategy Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: none;
            justify-content: center; align-items: center; z-index: 100;
        }
        .strategy-paper {
            background: white; width: 90%; max-width: 1100px; height: 90vh; padding: 0;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            border-radius: 8px; position: relative;
            display: flex; flex-direction: column;
            overflow: hidden;
        }
        .strategy-header { 
            background: var(--ust-black); color: white; padding: 20px 30px;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 4px solid var(--ust-orange);
        }
        
        .strategy-content { flex: 1; overflow-y: auto; padding: 30px; }

        .strategy-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 0.9rem; }
        .strategy-table th { text-align: left; background: #f4f7fa; padding: 12px; color: var(--ust-black); border-bottom: 2px solid var(--ust-orange); }
        .strategy-table td { padding: 12px; border-bottom: 1px solid #eee; vertical-align: top; }
        
        .est-table th { background: var(--ust-black); color: white; border-bottom: none; }
        .est-table tr:last-child { font-weight: bold; background: #f9f9f9; }

        .rec-tag { 
            display: inline-block; background: var(--ust-light-grey); color: #333; 
            padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; margin-right: 5px; margin-bottom: 5px; border: 1px solid #ddd;
        }

        .btn-group { display: flex; gap: 10px; padding: 20px; border-top: 1px solid #eee; background: #fff; justify-content: flex-end;}
        .btn-secondary { background: white; color: #333; padding: 10px 20px; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; }
        .btn-action { background: var(--ust-orange); color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }

        /* Diagram Container */
        .diagram-box {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            background: #fafafa;
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            min-height: 150px;
        }
        
        /* Boxes */
        .ai-summary-box {
            background: #f7f9ff;
            border-left: 4px solid var(--ai-blue);
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 0 4px 4px 0;
        }
        
        .test-strategy-box {
            background: #e8f0fe;
            border-left: 4px solid #4285f4;
            padding: 15px;
            margin-top: 20px;
            border-radius: 0 4px 4px 0;
        }
        
        .pii-warning-box {
            background: #fff8f8; border-left: 4px solid var(--danger); padding: 15px; margin-bottom: 20px;
        }
        
        .platform-rec-box {
            background: #f0f9f4; border-left: 4px solid var(--success); padding: 15px; margin-bottom: 20px;
        }
        
        .benefit-box {
            background: #f0f4ff; border-left: 4px solid var(--ai-blue); padding: 15px; margin-bottom: 20px;
        }

    </style>
</head>
<body>

    <!-- Sidebar Input -->
    <div class="sidebar">
        <div class="logo"><span>UST</span> &nbsp;Example Assessment</div>
        
        <label>1. RAML Definition (API Spec)</label>
        <textarea id="ramlInput" placeholder="Paste RAML definition...">#%RAML 1.0
title: SAP Order Sync API
version: v2
protocols: [HTTPS]
securedBy: [oauth_2_0]

types:
  Order:
    properties:
      orderId: string
      items: array
      total: number
      customerEmail: string
      creditCardToken: string
</textarea>

        <label>2. Mule XML (Flow Logic)</label>
        <textarea id="xmlInput" placeholder="Paste Mule XML Flow logic..."><flow name="syncOrdersToSAP">
    <http:listener path="/orders" config-ref="HTTP_Config" />
    <client-id-enforcement />
    
    <ee:transform>
        <dw:set-payload>output application/json --- payload</dw:set-payload>
    </ee:transform>

    <flow-ref name="validateOrder" />
    
    <!-- Complex Pattern: Scatter Gather logic -->
    <scatter-gather doc:name="Scatter-Gather">
        <route>
            <vm:publish queueName="auditLog" />
        </route>
        <route>
            <foreach collection="#[payload.items]">
                <db:insert config-ref="SAP_DB">
                    <db:sql>INSERT INTO Items...</db:sql>
                </db:insert>
            </foreach>
        </route>
    </scatter-gather>

    <error-handler>
        <on-error-propagate>
            <logger message="Sync Failed" level="ERROR" />
        </on-error-propagate>
    </error-handler>
</flow>

<flow name="validateOrder">
    <choice>
        <when expression="#[payload.total < 0]">
            <raise-error type="ORDER:INVALID" />
        </when>
        <otherwise>
            <logger message="Order Valid" />
        </otherwise>
    </choice>
</flow></textarea>

        <label>3. MUnit Tests (XML)</label>
        <textarea id="munitInput" placeholder="Paste MUnit XML (Optional)..."><munit:test name="syncOrdersTest" description="Test happy path">
    <munit:execution>
        <flow-ref name="syncOrdersToSAP"/>
    </munit:execution>
    <munit:validation>
        <munit-tools:assert-that expression="#[payload]" is="#[MunitTools::notNullValue()]"/>
    </munit:validation>
</munit:test>
</textarea>

        <button class="primary-btn" onclick="analyze()">
            <span>üöÄ</span> Generate Assessment
        </button>
        
        <div style="margin-top: auto; text-align: center; font-size: 0.7rem; color: #999; padding-top: 20px;">
            Powered by UST Transformation Solutions
        </div>
    </div>

    <!-- Main Report Area -->
    <div class="main-content" id="reportArea" style="display:none;">
        
        <!-- Top Stats -->
        <div class="section-header">
            <div>
                <h2>Example Assessment Report</h2>
                <div style="color: #666; font-size: 0.9rem;">Target: Workato Automation Platform</div>
            </div>
            <button class="btn-action" onclick="showStrategy()">üìÑ View Full Estimation & Strategy</button>
        </div>

        <div class="dashboard-grid">
            <!-- Complexity & Estimates -->
            <div class="stat-card">
                <div class="stat-label">Total Estimated Effort</div>
                <div class="stat-value" id="statTotalDays">0 Days</div>
                <div class="effort-breakdown">
                    <div class="effort-pill"><strong id="statDesign">0</strong>Design</div>
                    <div class="effort-pill"><strong id="statDev">0</strong>Dev</div>
                    <div class="effort-pill"><strong id="statTest">0</strong>Test</div>
                </div>
            </div>

            <!-- MuleSoft Complexity Score -->
            <div class="stat-card">
                <div class="stat-value" id="statMuleScore">0</div>
                <div class="stat-label">Mule Complexity Score</div>
                <div style="font-size: 0.75rem; color: #666; margin-top: 5px;">Based on components & logic density</div>
            </div>

            <!-- PII / Data -->
            <div class="stat-card" id="piiCard">
                <div class="stat-value" id="statPII">Low Risk</div>
                <div class="stat-label">Data Privacy / PII</div>
                <div style="font-size: 0.8rem; color: #666; margin-top: 5px;" id="statPIIDetails">No PII keywords detected</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-value" id="statFlows">0</div>
                <div class="stat-label">Recipes Required</div>
            </div>
        </div>

        <!-- AI Summary -->
        <div class="ai-summary-box">
            <h4 style="margin-top:0; color:var(--ai-blue);">ü§ñ AI-Generated Purpose Summary</h4>
            <p id="aiSummaryText" style="margin:5px 0 0 0; font-size:0.9rem;"></p>
        </div>

        <!-- Technical Analysis -->
        <div class="analysis-section">
            <div class="section-header">
                <h3>Visual Migration Map</h3>
                <span style="font-size: 0.85rem; color: #666;">Source vs Target Component Mapping</span>
            </div>
            <div id="flowContainer"></div>
        </div>
    </div>

    <!-- Strategy Modal -->
    <div class="modal-overlay" id="strategyModal">
        <div class="strategy-paper">
            <div class="strategy-header">
                <div>
                    <h2 style="margin:0; color:white;">Migration Strategy & Estimation</h2>
                    <p style="color:#ccc; margin:5px 0 0 0; font-size: 0.9rem;">UST Technical Recommendation Report</p>
                </div>
                <div style="text-align:right;">
                    <p style="margin:0;"><strong>Date:</strong> <span id="reportDate"></span></p>
                    <div style="background:rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 4px; display:inline-block; margin-top:5px; font-size:0.8rem;">CONFIDENTIAL</div>
                </div>
            </div>

            <div class="strategy-content">
                
                <!-- AI Summary -->
                <div class="ai-summary-box">
                    <h4 style="margin-top:0; color:var(--ai-blue);">ü§ñ AI-Generated Purpose Summary</h4>
                    <p id="modalAiSummaryText" style="margin:5px 0 0 0; font-size:0.9rem;"></p>
                </div>
                
                <!-- Workato Benefits -->
                <div id="workatoBenefitBox"></div>
                
                <!-- PII Warning -->
                <div id="modalPIIBox"></div>
                
                <!-- Platform Recommendations -->
                <div id="platformRecsBox"></div>

                <!-- Effort Estimation Table -->
                 <h3 style="color: var(--ust-black); border-bottom: 2px solid var(--ust-orange); padding-bottom: 10px;">Project Estimation Breakdown (Days)</h3>
                 <table class="strategy-table est-table">
                    <thead>
                        <tr>
                            <th>Recipe Scope</th>
                            <th>Mule Complexity</th>
                            <th>Design</th>
                            <th>Develop</th>
                            <th>Test / QA</th>
                            <th>Total Days</th>
                        </tr>
                    </thead>
                    <tbody id="estimationBody">
                        <!-- Injected via JS -->
                    </tbody>
                 </table>

                <!-- Architecture Diagram -->
                <h3 style="color: var(--ust-black); border-bottom: 2px solid var(--ust-orange); padding-bottom: 10px;">Target Architecture Visual</h3>
                <div class="diagram-box">
                    <div class="mermaid" id="mermaidGraph">
                        <!-- Diagram injected here -->
                    </div>
                </div>

                <!-- MUnit Strategy -->
                <div id="testStrategyContainer"></div>

                <!-- Detailed Recommendations -->
                <h3 style="margin-top: 30px; color: var(--ust-black); border-bottom: 2px solid var(--ust-orange); padding-bottom: 10px;">Technical Migration Recommendations</h3>
                <table class="strategy-table">
                    <thead>
                        <tr>
                            <th style="width:20%">Source Pattern</th>
                            <th style="width:25%">Workato Capability</th>
                            <th style="width:45%">Architecture Recommendation</th>
                            <th style="width:10%">Risk</th>
                        </tr>
                    </thead>
                    <tbody id="strategyBody">
                        <!-- Injected via JS -->
                    </tbody>
                </table>

            </div>

            <div class="btn-group">
                <button class="btn-secondary" onclick="closeStrategy()">Close</button>
                <button class="btn-action" onclick="window.print()">üñ®Ô∏è Print / PDF</button>
            </div>
        </div>
    </div>

    <script>
        // Initialize Mermaid
        mermaid.initialize({ startOnLoad: false, theme: 'neutral' });

        let globalAssessment = null;

        // --- PII Detection Logic ---
        const PII_KEYWORDS = ['email', 'ssn', 'socialsecurity', 'creditcard', 'cardnumber', 'dob', 'birth', 'salary', 'password', 'secret', 'token', 'passport'];

        // --- Simulated AI Content Analysis ---
        function analyzeContentPurpose(ramlData, xmlText) {
            let purpose = "";
            
            // 1. Identify Subject (from RAML types or XML flow name)
            let subject = "data payload";
            if (ramlData && ramlData.title) {
                subject = ramlData.title.split(' ')[0].replace(/API/i, '');
            } else if (xmlText.includes("Order")) {
                subject = "Orders";
            }

            // 2. Identify Trigger/Source
            let source = "an unspecified source";
            if (xmlText.includes("http:listener")) {
                source = "an external application via an API trigger";
            } else if (xmlText.includes("scheduler")) {
                source = "a recurring time schedule";
            }

            // 3. Identify Destination/Action
            let destination = "an unknown endpoint";
            let action = "process the data";
            
            if (xmlText.includes("db:insert") || xmlText.includes("SAP")) {
                destination = "the SAP database";
                action = "insert individual records";
            } else if (xmlText.includes("vm:publish") || xmlText.includes("auditLog")) {
                destination = "an internal queue for auditing/further processing";
                action = "publish a message";
            }

            purpose = `This interface is primarily focused on handling <strong>${subject}</strong>. The data is initiated by ${source}, then validated against business rules (e.g., preventing negative totals).`;
            
            // 4. Add Complex Logic Detail
            if (xmlText.includes("scatter-gather")) {
                purpose += ` It utilizes a complex <strong>Scatter-Gather</strong> pattern to execute multiple processing paths in parallel, such as logging data to a queue and asynchronously inserting records into a database.`;
            } else {
                 purpose += ` The main business action is to ${action} into ${destination}.`;
            }
            if (xmlText.includes("error-handler")) {
                purpose += ` Comprehensive <strong>error handling</strong> is in place to manage transaction failures gracefully.`;
            }

            return purpose;
        }

        function analyze() {
            const raml = document.getElementById('ramlInput').value;
            const xml = document.getElementById('xmlInput').value;
            const munit = document.getElementById('munitInput').value;
            
            // 1. Parse Inputs
            let ramlData = {};
            try { ramlData = jsyaml.load(raml); } catch(e) {}
            
            const flows = extractFlows(xml);
            const piiFound = detectPII(ramlData, xml);
            const testAnalysis = extractMUnits(munit);
            const contentPurpose = analyzeContentPurpose(ramlData, xml);

            // 2. Calculate Metrics
            const assessment = calculateAssessment(flows, ramlData, testAnalysis, piiFound, contentPurpose);
            globalAssessment = assessment;

            // 3. Render
            renderReport(assessment);
        }

        function detectPII(ramlData, xmlText) {
            const detected = new Set();
            
            // 1. Scan RAML Types
            if (ramlData && ramlData.types) {
                JSON.stringify(ramlData.types, (key, value) => {
                    if (typeof key === 'string') {
                        PII_KEYWORDS.forEach(k => {
                            if (key.toLowerCase().includes(k)) detected.add(key);
                        });
                    }
                    return value;
                });
            }

            // 2. Scan XML Logic
            PII_KEYWORDS.forEach(k => {
                if (xmlText.toLowerCase().includes(k)) detected.add(k);
            });

            return Array.from(detected);
        }

        function extractFlows(xmlText) {
            const flows = [];
            const flowRegex = /<flow.*?name=["'](.*?)["'].*?>([\s\S]*?)<\/flow>/gi;
            let match;
            
            while ((match = flowRegex.exec(xmlText)) !== null) {
                const name = match[1];
                const content = match[2];
                
                const components = [];
                const workatoSteps = [];
                const strategies = [];
                let points = 1; // Base complexity

                // --- COMPONENT DETECTION ---

                // 1. API & Listeners
                if (content.includes("http:listener")) {
                    components.push({icon: "‚ö°", text: "HTTP Listener"});
                    workatoSteps.push({icon: "‚ö°", text: "API Trigger"});
                    strategies.push({
                        source: "HTTP Listener", target: "API Platform",
                        rec: "Use Workato API Platform. Define Endpoint, Output Schema, and enforcement policies.",
                        tags: ["API Platform"], risk: "Low"
                    });
                } 
                
                // 2. Scheduling
                if (content.includes("scheduler") || content.includes("poll")) {
                    components.push({icon: "‚è∞", text: "Scheduler"});
                    workatoSteps.push({icon: "‚è∞", text: "Scheduled Trigger"});
                    strategies.push({ source: "Poll", target: "Schedule", rec: "Use standard interval trigger.", tags: ["Batch"], risk: "Low" });
                }

                // 3. Transformation
                if (content.includes("transform") || content.includes("ee:transform")) {
                    components.push({icon: "üîß", text: "DataWeave"});
                    workatoSteps.push({icon: "üìù", text: "Formula / SQL"});
                    strategies.push({
                        source: "DataWeave", target: "Formula Mode",
                        rec: "Convert logic to Workato Formulas. Use SQL Transformation for heavy array joins. Leverage Copilot for conversion.",
                        tags: ["Transformation"], risk: "Med"
                    });
                    points += 2;
                }

                // 4. Database
                if (content.includes("db:") || content.includes("database") || content.includes("SAP_DB")) {
                    components.push({icon: "üóÑÔ∏è", text: "Database (SAP)"});
                    workatoSteps.push({icon: "üîå", text: "SAP / SQL Connector"});
                    strategies.push({ source: "DB Connector", target: "SAP BAPI/SQL", rec: "Requires On-Prem Agent (OPA) if SAP is behind firewall. Prefer SAP BAPI for structured calls.", tags: ["Connectivity"], risk: "High" });
                    points += 2;
                }

                // 5. Looping & Batch
                if (content.includes("foreach")) {
                    components.push({icon: "üîÑ", text: "For Each"});
                    workatoSteps.push({icon: "üîÅ", text: "Repeat Loop"});
                    strategies.push({ source: "Foreach", target: "Repeat Action", rec: "Use Repeat for <10k items. Use Batch/Bulk triggers for larger sets.", tags: ["Optimization"], risk: "Med" });
                    points += 3;
                }
                
                // 6. Advanced Routing (Scatter-Gather / Choice)
                if (content.includes("scatter-gather")) {
                    components.push({icon: "‚ö°", text: "Scatter-Gather"});
                    workatoSteps.push({icon: "‚ö°", text: "Parallel / Async"});
                    strategies.push({ source: "Scatter-Gather", target: "Async Call", rec: "Use 'Call Recipe (Async)' to simulate parallel processing and isolate failure domains.", tags: ["Advanced", "Resilience"], risk: "High" });
                    points += 5;
                }
                if (content.includes("choice")) {
                    components.push({icon: "üîÄ", text: "Choice"});
                    workatoSteps.push({icon: "‚ùì", text: "IF/ELSE"});
                    strategies.push({ source: "Choice", target: "IF/ELSE", rec: "Standard conditional blocks.", tags: ["Logic"], risk: "Low" });
                    points += 2;
                }

                // 7. Messaging / Queues
                if (content.includes("vm:") || content.includes("jms:") || content.includes("anypoint-mq")) {
                    components.push({icon: "üì®", text: "Queue/VM (auditLog)"});
                    workatoSteps.push({icon: "üì®", text: "Pub/Sub"});
                    strategies.push({ source: "VM/JMS", target: "Pub/Sub", rec: "Replace internal queues with Workato Pub/Sub topics for decoupling.", tags: ["Messaging"], risk: "Med" });
                    points += 3;
                }

                // 8. Error Handling
                if (content.includes("error-handler") || content.includes("on-error")) {
                    components.push({icon: "‚ö†Ô∏è", text: "Error Handler"});
                    workatoSteps.push({icon: "üõ°Ô∏è", text: "Monitor/Rescue"});
                    strategies.push({ source: "Error Scope", target: "Monitor Block", rec: "Wrap logic in Monitor. In Rescue, call centralized Notification recipe.", tags: ["Resilience"], risk: "Med" });
                    points += 2;
                }

                let size = points > 12 ? "High" : points > 6 ? "Medium" : "Low";

                flows.push({ name, components, workatoSteps, strategies, complexity: size, points });
            }
            return flows;
        }

        function extractMUnits(xmlText) {
            const testCount = (xmlText.match(/<munit:test/g) || []).length;
            return { count: testCount };
        }

        function calculateAssessment(flows, raml, tests, pii, contentPurpose) {
            let totalPoints = 0;
            let designDays = 0;
            let devDays = 0;
            let testDays = 0;

            flows.forEach(f => {
                totalPoints += f.points;
                
                // Days per complexity level (Heuristics)
                if (f.complexity === 'Low') {
                    f.est = { design: 0.5, dev: 1, test: 0.5 };
                } else if (f.complexity === 'Medium') {
                    f.est = { design: 1.5, dev: 3, test: 2 };
                } else { // High
                    f.est = { design: 3, dev: 6, test: 4 };
                }

                designDays += f.est.design;
                devDays += f.est.dev;
                testDays += f.est.test;
            });

            // Test effort adjustment
            if (tests.count > 0) testDays += (tests.count * 0.25);

            const totalDays = designDays + devDays + testDays;

            return { 
                flows, tests, pii, totalPoints, contentPurpose,
                estimates: { design: designDays, dev: devDays, test: testDays, total: totalDays } 
            };
        }

        function renderReport(data) {
            document.getElementById('reportArea').style.display = "block";
            
            // Dashboard Stats
            document.getElementById('statTotalDays').innerText = data.estimates.total.toFixed(1) + " Days";
            document.getElementById('statDesign').innerText = data.estimates.design.toFixed(1);
            document.getElementById('statDev').innerText = data.estimates.dev.toFixed(1);
            document.getElementById('statTest').innerText = data.estimates.test.toFixed(1);
            
            document.getElementById('statMuleScore').innerText = data.totalPoints;
            document.getElementById('statFlows').innerText = data.flows.length;
            
            // AI Summary
            document.getElementById('aiSummaryText').innerHTML = data.contentPurpose;
            document.getElementById('modalAiSummaryText').innerHTML = data.contentPurpose;


            // PII
            const piiCard = document.getElementById('piiCard');
            const piiText = document.getElementById('statPII');
            const piiDet = document.getElementById('statPIIDetails');
            if (data.pii.length > 0) {
                piiText.innerText = "High Risk";
                piiText.style.color = "var(--danger)";
                piiCard.style.borderLeftColor = "var(--danger)";
                piiDet.innerText = "Detected: " + data.pii.join(", ");
            } else {
                piiText.innerText = "Low Risk";
                piiText.style.color = "var(--success)";
                piiCard.style.borderLeftColor = "var(--success)";
                piiDet.innerText = "No PII keywords";
            }

            // Flows
            const container = document.getElementById('flowContainer');
            container.innerHTML = "";

            data.flows.forEach(flow => {
                let badgeColor = flow.complexity === 'Low' ? 'badge-s' : flow.complexity === 'Medium' ? 'badge-m' : 'badge-l';
                let piiBadge = data.pii.length > 0 ? `<span class="pii-badge">Confidential</span>` : '';

                let html = `
                <div class="flow-card">
                    <div class="flow-header">
                        <div>
                            <strong style="font-size:1rem;">${flow.name}</strong> ${piiBadge}
                        </div>
                        <span class="badge ${badgeColor}">${flow.complexity} (${flow.points} pts)</span>
                    </div>
                    <div class="flow-body">
                        <div class="mapping-col">
                            <div style="font-size:0.8rem; color:#888; margin-bottom:10px;">MULESOFT SOURCE</div>
                            ${flow.components.map(c => `<div class="mapping-step"><span class="icon">${c.icon}</span> ${c.text}</div>`).join('')}
                        </div>
                        <div class="mapping-col" style="border-left: 1px dashed #ccc; padding-left:20px;">
                            <div style="font-size:0.8rem; color:var(--ust-orange); margin-bottom:10px; font-weight:bold;">WORKATO TARGET</div>
                            ${flow.workatoSteps.map(s => `<div class="mapping-step"><span class="icon">${s.icon}</span> ${s.text}</div>`).join('')}
                        </div>
                    </div>
                </div>`;
                container.innerHTML += html;
            });
        }

        function getWorkatoBenefits(data) {
             let benefits = [];
             
             // 1. API Benefit
             if (data.flows.some(f => f.components.some(c => c.text.includes("HTTP")))) {
                 benefits.push(`<strong>Faster API Deployment:</strong> Quickly translate API specs (RAML) into live Workato API endpoints, drastically reducing time-to-market compared to traditional deployment cycles.`);
             }

             // 2. Resilience/Logging Benefit
             if (data.flows.some(f => f.components.some(c => c.text.includes("Error Handler")) || c.text.includes("Queue"))) {
                 benefits.push(`<strong>Enhanced Operational Resilience:</strong> Seamlessly replace VM/JMS queues with Workato's Pub/Sub for native decoupling, and leverage built-in job history and automatic recipe monitoring for superior error tracking.`);
             }

             // 3. Transformation Benefit
             if (data.flows.some(f => f.components.some(c => c.text.includes("DataWeave")))) {
                 benefits.push(`<strong>Simplified Development:</strong> Replace complex DataWeave with Workato's user-friendly formula language and visual mapping tools. Use Workato Copilot to convert legacy transformation scripts with AI assistance.`);
             }

             // 4. Connectivity Benefit
             if (data.flows.some(f => f.components.some(c => c.text.includes("Database") || c.text.includes("SAP")))) {
                 benefits.push(`<strong>Comprehensive Connectivity:</strong> Utilize Workato's native, certified connectors for systems like SAP, reducing the need for custom coding and increasing integration stability.`);
             }
             
             return benefits;
        }


        async function showStrategy() {
            if(!globalAssessment) return;
            document.getElementById('strategyModal').style.display = "flex";
            document.getElementById('reportDate').innerText = new Date().toLocaleDateString();
            
            const data = globalAssessment;

            // 1. Workato Benefits
            const benefitBox = document.getElementById('workatoBenefitBox');
            const benefits = getWorkatoBenefits(data);
            let benefitHtml = `<div class="benefit-box">
                <h4 style="margin-top:0; color:var(--ai-blue);">üåü Key Benefits of Workato Migration</h4>
                <ul style="font-size:0.9rem; padding-left:20px; margin-bottom:0;">
                ${benefits.map(b => `<li>${b}</li>`).join('')}
                </ul>
            </div>`;
            benefitBox.innerHTML = benefitHtml;


            // 2. Platform Recommendations (Strategic)
            const recBox = document.getElementById('platformRecsBox');
            let recHtml = `<div class="platform-rec-box">
                <h4 style="margin-top:0; color:#137333;">‚úÖ Workato Platform Recommendations</h4>
                <ul style="font-size:0.9rem; padding-left:20px; margin-bottom:0;">`;
            
            // Dynamic Recs
            const hasAPI = data.flows.some(f => f.components.some(c => c.text.includes("HTTP")));
            const hasQueue = data.flows.some(f => f.components.some(c => c.text.includes("Queue")));
            const hasScatter = data.flows.some(f => f.components.some(c => c.text.includes("Scatter")));
            
            if(hasAPI) recHtml += `<li><strong>API Platform:</strong> Utilize Workato API Management for centralized policy enforcement (OAuth, Rate Limiting) and usage analytics.</li>`;
            if(hasQueue) recHtml += `<li><strong>Pub/Sub:</strong> Replace VM/JMS queues with Workato Pub/Sub topics to decouple triggers from processing logic.</li>`;
            if(hasScatter) recHtml += `<li><strong>Async Processing:</strong> Complex parallel logic detected. Use 'Call Recipe (Async)' with error handling for non-blocking execution.</li>`;
            
            recHtml += `<li><strong>Recipe Lifecycle Management (RLM):</strong> Implement RLM for promotion of recipes from Dev to QA to Production environments.</li>`;
            recHtml += `<li><strong>Workato Copilot:</strong> Accelerate SQL and Formula migration by using Copilot to translate DataWeave scripts.</li>`;
            recHtml += `</ul></div>`;
            recBox.innerHTML = recHtml;

            // 3. PII Warning
            const piiBox = document.getElementById('modalPIIBox');
            if (data.pii.length > 0) {
                piiBox.innerHTML = `<div class="pii-warning-box"><h4 style="margin:0; color:var(--danger);">‚ö†Ô∏è Sensitive Data Detected</h4><p style="margin:5px 0 0 0; font-size:0.9rem;">Keywords: <strong>${data.pii.join(", ")}</strong>. Enable Workato 'Masked Data' controls and limit Job History retention as per data privacy compliance requirements.</p></div>`;
            } else { piiBox.innerHTML = ""; }

            // 4. Estimation Table
            const estBody = document.getElementById('estimationBody');
            estBody.innerHTML = "";
            data.flows.forEach(f => {
                 estBody.innerHTML += `<tr>
                    <td>${f.name}</td>
                    <td>${f.points} pts (${f.complexity})</td>
                    <td>${f.est.design}</td>
                    <td>${f.est.dev}</td>
                    <td>${f.est.test}</td>
                    <td><strong>${(f.est.design + f.est.dev + f.est.test).toFixed(1)}</strong></td>
                 </tr>`;
            });
            estBody.innerHTML += `<tr><td>TOTAL</td><td>${data.totalPoints} pts</td><td>${data.estimates.design.toFixed(1)}</td><td>${data.estimates.dev.toFixed(1)}</td><td>${data.estimates.test.toFixed(1)}</td><td>${data.estimates.total.toFixed(1)} Days</td></tr>`;

            // 5. Test Strategy
            const testStrategyContainer = document.getElementById('testStrategyContainer');
            testStrategyContainer.innerHTML = `<div class="test-strategy-box"><h4 style="margin-top:0; color:#1a73e8;">üß™ Testing Requirements & Strategy</h4><p style="font-size:0.9rem;">
            Detected <strong>${data.tests.count} MUnit test(s)</strong>. The migration strategy requires converting these into Workato Unit Tests using recipe-level test variables (e.g., setting a 'is_test' flag) and utilizing the <strong>Test Recipe</strong> feature. For complex validation logic like the 'validateOrder' flow, the new Workato recipe must be called directly within a test harness to verify expected success/failure states.
            </p></div>`;

            // 6. Diagram
            let mermaidStr = "graph TD;\n";
            data.flows.forEach(flow => {
                const safeName = 'flow_' + flow.name.replace(/[^a-zA-Z0-9]/g, '');
                mermaidStr += `  ${safeName}[Recipe: ${flow.name}]:::recipe\n`;
                if(flow.components.some(c => c.text.includes("HTTP"))) mermaidStr += `  Client(External System) -->|API Call| ${safeName}\n`;
                if(flow.components.some(c => c.text.includes("Database"))) mermaidStr += `  ${safeName} -->|SQL/BAPI| DB[(SAP Database)]\n`;
                if(flow.components.some(c => c.text.includes("Scatter"))) mermaidStr += `  ${safeName} -->|Async Call| Worker(Audit Worker Recipe)\n`;
            });
            mermaidStr += `  classDef recipe fill:#f9f9f9,stroke:#D6001C,stroke-width:2px;\n`;
            const graphDiv = document.getElementById('mermaidGraph');
            graphDiv.innerHTML = mermaidStr;
            graphDiv.removeAttribute('data-processed');
            try { await mermaid.run({ nodes: [graphDiv] }); } catch (e) {}

            // 7. Recommendations Table
            const tbody = document.getElementById('strategyBody');
            tbody.innerHTML = "";
            data.flows.forEach(flow => {
                flow.strategies.forEach(strat => {
                    let riskColor = strat.risk === 'High' ? '#fce8e6' : strat.risk === 'Med' ? '#fef7e0' : '#e6f4ea';
                    let tagsHtml = strat.tags.map(t => `<span class="rec-tag">${t}</span>`).join('');
                    tbody.innerHTML += `<tr><td><strong>${strat.source}</strong><br><span style="font-size:0.8rem; color:#888;">in ${flow.name}</span></td><td>${strat.target}</td><td>${tagsHtml}<br>${strat.rec}</td><td><span style="background:${riskColor}; padding:2px 6px; border-radius:4px; font-size:0.8rem;">${strat.risk}</span></td></tr>`;
                });
            });
        }

        function closeStrategy() { document.getElementById('strategyModal').style.display = "none"; }
    </script>
</body>
</html>
